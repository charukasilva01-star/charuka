<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainFlow Survival - Stay Dry!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0A74DA;
            --secondary-light: #B4E8FF;
            --background-dark: #1F2937;
            --dryness-green: #10B981;
            --dryness-red: #EF4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b111a;
            color: white;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        #gameContainer {
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-radius: 1rem;
            overflow: hidden;
            background-color: var(--background-dark);
            border: 4px solid var(--primary-blue);
        }

        canvas {
            display: block;
            background: linear-gradient(180deg, #1e3a8a 0%, #172554 100%);
            touch-action: none; /* Allows canvas to handle touch events */
        }

        .btn-game {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px var(--primary-blue);
        }

        .btn-game:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px var(--primary-blue);
        }

        .btn-game:active {
            transform: translateY(3px);
            box-shadow: 0 1px var(--primary-blue);
        }

        /* Styling for the status bar */
        #drynessBar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        
        /* Custom styles for the player character (using an emoji) */
        .player-emoji {
            font-size: 2rem;
            line-height: 1;
            user-select: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="gameContainer" class="flex flex-col">
    <!-- Header -->
    <header class="p-6 bg-gray-800 border-b-2 border-gray-700">
        <h1 class="text-3xl font-extrabold text-white text-center tracking-wider">
            <span class="text-secondary-light">RainFlow</span> Survival
        </h1>
        <p class="text-sm text-gray-400 text-center mt-1">Keep your gear dry. Navigate the downpour!</p>
    </header>

    <!-- Score and Dryness Status -->
    <div class="p-4 flex justify-between items-center bg-gray-700">
        <div class="text-lg font-bold">Score: <span id="scoreDisplay" class="text-yellow-400">0</span></div>
        <div class="flex items-center space-x-2">
            <span class="font-bold">Dryness:</span>
            <div class="w-32 h-6 bg-gray-800 rounded-full border border-gray-500 overflow-hidden">
                <div id="drynessBar" style="width: 100%; background-color: var(--dryness-green);"></div>
            </div>
        </div>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas" width="600" height="400"></canvas>

    <!-- Controls and Messages -->
    <div class="p-4 bg-gray-800 flex flex-col items-center space-y-3">
        <div id="messageBox" class="text-xl font-bold text-center h-8">
            <span id="gameStatus" class="text-secondary-light">Click Start to Play!</span>
        </div>
        <button id="startButton" class="btn-game bg-green-500 text-white font-bold py-3 px-8 rounded-xl w-full sm:w-auto text-lg hover:bg-green-600">
            Start Game
        </button>
        <div class="text-xs text-gray-500 mt-2">Use A/D or Left/Right Arrow keys or swipe/tap the canvas to move.</div>
    </div>

    <!-- Promotional Call to Action -->
    <footer class="p-6 bg-gray-900 text-center">
        <p class="text-md font-semibold text-secondary-light">
            Need real-life RainFlow Survival?
        </p>
        <p class="text-sm text-gray-400 mt-1">
            Check out our rainproof jackets and bags for ultimate dryness protection!
        </p>
        <a href="#" class="inline-block mt-3 px-4 py-2 text-sm font-bold bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition">
            Explore RainFlow Gear
        </a>
    </footer>
</div>

<script>
    // --- GAME CONSTANTS AND VARIABLES ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const drynessBar = document.getElementById('drynessBar');
    const gameStatus = document.getElementById('gameStatus');

    let gameInterval;
    let isGameRunning = false;
    let score = 0;
    let dryness = 100; // Player's health

    // Player Object
    const player = {
        x: canvas.width / 2,
        y: canvas.height - 40,
        width: 30,
        height: 30,
        speed: 8,
        dx: 0,
        emoji: 'ðŸš¶', // Represents the user protected by RainFlow gear
        draw: function() {
            ctx.font = `${this.height}px Inter`;
            ctx.textAlign = 'center';
            ctx.fillText(this.emoji, this.x, this.y);
        }
    };

    // Item Arrays
    let raindrops = []; // Hazards (reduce dryness)
    let powerups = [];  // RainFlow Logos (restore dryness/points)

    // --- GAME MECHANICS ---

    function resetGame() {
        score = 0;
        dryness = 100;
        raindrops = [];
        powerups = [];
        player.x = canvas.width / 2;
        player.dx = 0;
        updateScoreDisplay();
        updateDrynessBar();
        gameStatus.textContent = 'Ready!';
    }

    function startGame() {
        if (isGameRunning) return;
        resetGame();
        isGameRunning = true;
        startButton.textContent = 'Restart Game';
        gameStatus.textContent = 'Keep Moving!';
        
        // Start generating items
        // Wait a moment to ensure the canvas size is stable
        setTimeout(() => {
            spawnItem('rain');
            setTimeout(() => spawnItem('powerup'), 3000);
        }, 100); 
        
        gameLoop();
    }

    function endGame() {
        isGameRunning = false;
        gameStatus.textContent = `Game Over! Final Score: ${score}`;
        startButton.textContent = 'Play Again';
        
        // Custom message box for Game Over
        const message = `ðŸ’§ Oh no, you got soaked! Dryness reached 0%. \nYour Score: ${score}.`;
        showModal(message, 'Game Over');
    }

    // --- UI UPDATES ---

    function updateScoreDisplay() {
        scoreDisplay.textContent = score;
    }

    function updateDrynessBar() {
        // Clamp dryness between 0 and 100
        dryness = Math.max(0, Math.min(100, dryness));
        drynessBar.style.width = dryness + '%';

        // Change color based on health level
        if (dryness > 60) {
            drynessBar.style.backgroundColor = 'var(--dryness-green)';
        } else if (dryness > 25) {
            drynessBar.style.backgroundColor = '#F59E0B'; // Yellow/Amber
        } else {
            drynessBar.style.backgroundColor = 'var(--dryness-red)';
        }
        
        if (dryness <= 0) {
            endGame();
        }
    }

    // --- ITEM GENERATION ---

    function spawnItem(type) {
        if (!isGameRunning) return;

        const x = Math.random() * (canvas.width - 20) + 10;
        const speed = 2 + (score / 200) * 0.5; // Speed increases with score

        if (type === 'rain') {
            raindrops.push({
                x: x,
                y: -10,
                radius: Math.random() * 8 + 6,
                dy: speed,
                emoji: 'ðŸ’§'
            });
            // Spawn next rain item faster as score increases
            let nextRainTime = Math.max(200, 1000 - score);
            setTimeout(() => spawnItem('rain'), nextRainTime);
        } else if (type === 'powerup') {
            powerups.push({
                x: x,
                y: -10,
                radius: 12,
                dy: speed * 0.8, // Slightly slower than rain
                emoji: 'ðŸŒ€', // Represents RainFlow logo/swirl
                value: 20
            });
            // Powerups are rarer
            let nextPowerupTime = Math.max(3000, 6000 - score * 5);
            setTimeout(() => spawnItem('powerup'), nextPowerupTime);
        }
    }

    // --- DRAWING FUNCTIONS ---

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawItems() {
        // Draw Raindrops
        ctx.font = '24px Inter';
        raindrops.forEach(drop => {
            ctx.textAlign = 'center';
            ctx.fillText(drop.emoji, drop.x, drop.y);
        });

        // Draw Powerups (RainFlow Logo)
        ctx.font = '28px Inter';
        powerups.forEach(powerup => {
            ctx.textAlign = 'center';
            ctx.fillText(powerup.emoji, powerup.x, powerup.y);
        });
    }

    // --- UPDATE/COLLISION LOGIC ---

    function updatePlayer() {
        // Move player
        player.x += player.dx;

        // Wall detection
        if (player.x < player.width / 2) {
            player.x = player.width / 2;
        } else if (player.x > canvas.width - player.width / 2) {
            player.x = canvas.width - player.width / 2;
        }
    }

    function updateItems() {
        // Update Raindrops
        raindrops.forEach(drop => {
            drop.y += drop.dy;
        });

        // Update Powerups
        powerups.forEach(powerup => {
            powerup.y += powerup.dy;
        });
    }

    function checkCollisions() {
        // Check Raindrop collisions
        raindrops = raindrops.filter(drop => {
            // Collision detection (simple rectangle approximation for the emoji)
            const collisionX = drop.x > player.x - player.width / 2 && drop.x < player.x + player.width / 2;
            const collisionY = drop.y > player.y - player.height && drop.y < player.y;

            if (collisionX && collisionY) {
                // Hit! Decrease dryness
                dryness -= 10;
                updateDrynessBar();
                gameStatus.textContent = '-10 Dryness!';
                return false; // Remove the hit raindrop
            }

            // Remove if off-screen (missed)
            if (drop.y > canvas.height) {
                score++;
                updateScoreDisplay();
                return false;
            }

            return true; // Keep drop
        });

        // Check Powerup collisions
        powerups = powerups.filter(powerup => {
            const collisionX = powerup.x > player.x - player.width / 2 && powerup.x < player.x + player.width / 2;
            const collisionY = powerup.y > player.y - player.height && powerup.y < player.y;

            if (collisionX && collisionY) {
                // Hit! Restore dryness and add score
                dryness += powerup.value;
                score += 50;
                updateScoreDisplay();
                updateDrynessBar();
                gameStatus.textContent = 'RainFlow Boost! +20 Dryness!';
                return false; // Remove the collected powerup
            }

            // Remove if off-screen (missed)
            if (powerup.y > canvas.height) {
                return false;
            }

            return true; // Keep powerup
        });
    }

    // --- GAME LOOP ---

    function gameLoop() {
        if (!isGameRunning) return;

        clearCanvas();
        updatePlayer();
        updateItems();
        checkCollisions();
        player.draw();
        drawItems();

        requestAnimationFrame(gameLoop);
    }

    // --- INPUT HANDLERS (Keyboard and Touch) ---

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (!isGameRunning) return;
        if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') {
            player.dx = player.speed;
        } else if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
            player.dx = -player.speed;
        }
    });

    document.addEventListener('keyup', (e) => {
        if (!isGameRunning) return;
        if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd' || e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') {
            player.dx = 0;
        }
    });
    
    // Touch/Click controls (Tap left half to move left, right half to move right)
    canvas.addEventListener('mousedown', handlePointerStart);
    canvas.addEventListener('touchstart', handlePointerStart);

    canvas.addEventListener('mouseup', handlePointerEnd);
    canvas.addEventListener('touchend', handlePointerEnd);
    canvas.addEventListener('touchcancel', handlePointerEnd);

    function handlePointerStart(e) {
        e.preventDefault();
        if (!isGameRunning) return;
        
        // Use clientX for both mouse and touch
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const rect = canvas.getBoundingClientRect();
        const touchX = clientX - rect.left;

        if (touchX < rect.width / 2) {
            // Left half
            player.dx = -player.speed;
        } else {
            // Right half
            player.dx = player.speed;
        }
    }

    function handlePointerEnd(e) {
        e.preventDefault();
        player.dx = 0;
    }

    // --- MODAL/MESSAGE BOX FUNCTION ---
    // Instead of alert(), use a custom simple modal

    function showModal(message, title) {
        let modal = document.getElementById('customModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'customModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none';
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300">
                    <h3 class="text-2xl font-bold mb-4 text-secondary-light" id="modalTitle"></h3>
                    <p class="text-white mb-6" id="modalMessage"></p>
                    <div class="flex justify-end">
                        <button id="modalClose" class="px-6 py-2 bg-primary-blue text-white font-semibold rounded-lg hover:bg-blue-600 transition">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('modalClose').addEventListener('click', () => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.querySelector('#customModal > div').classList.remove('scale-100');
                document.querySelector('#customModal > div').classList.add('scale-95');
            });
        }

        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').innerHTML = message.replace(/\n/g, '<br>'); // Support new lines
        
        // Show the modal with transition
        setTimeout(() => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.querySelector('#customModal > div').classList.remove('scale-95');
            document.querySelector('#customModal > div').classList.add('scale-100');
        }, 50);
    }

    // --- INITIALIZATION ---

    function setupCanvas() {
        const container = document.getElementById('gameContainer');
        // Set canvas width to container width
        canvas.width = container.clientWidth;
        // Maintain a good aspect ratio that fits mobile screens (e.g., 600x400 ratio)
        canvas.height = canvas.width * (400 / 600);
        
        // Reset player position based on new canvas size
        player.y = canvas.height - 40;
        player.x = canvas.width / 2;

        // Redraw initial state
        clearCanvas();
        player.draw();
    }

    window.onload = function() {
        setupCanvas();
        
        // Attach resize listener for responsiveness
        window.addEventListener('resize', setupCanvas);
        
        startButton.addEventListener('click', startGame);
        
        // Initial draw for the player
        player.draw();
    };

</script>
</body>
</html>